---
- hosts: all
  tasks:
          - file:
                  path: /etc/systemd/network
                  state: directory

          - ini_file:
                  path: /etc/systemd/network/{{ ansible_default_ipv4.interface }}.network
                  section: Match
                  option: Name
                  value: "{{ ansible_default_ipv4.interface }}"
                  no_extra_spaces: yes
          - ini_file:
                  path: /etc/systemd/network/{{ ansible_default_ipv4.interface }}.network
                  section: Network
                  option: DHCP
                  value: 'yes'
                  no_extra_spaces: yes
          - ini_file:
                  path: /etc/systemd/network/{{ ansible_default_ipv4.interface }}.network
                  section: Network
                  option: IPForward
                  value: 'yes'
                  no_extra_spaces: yes

          - systemd:
                  name: NetworkManager
                  enabled: no
          - systemd:
                  name: NetworkManager-wait-online.service
                  enabled: no
          - systemd:
                  name: systemd-networkd
                  enabled: yes

          - file:
                  path: /etc/resolv.conf
                  state: absent
          - file:
                  dest: /etc/resolv.conf
                  src: /run/systemd/resolve/resolv.conf
                  force: yes
                  state: link
          - systemd:
                  name: systemd-resolved
                  enabled: yes

          # Some silly bug was preventing openvpn to access resolv.conf
          # See: https://bugzilla.redhat.com/show_bug.cgi?id=1505106
          - ini_file:
                  path: /usr/lib/systemd/system/systemd-resolved.service
                  section: Service
                  option: ReadWritePaths
                  value: '/var/run/systemd/system'
                  no_extra_spaces: yes

          # The above bug is still happening, so we have an selinux module that
          # grants access
          - copy:
                src: openvpn-net_conf.pp
                dest: /root/
          - command: semodule -i /root/openvpn-net_conf.pp

          # Unfortunately systemd-networkd is not getting the hostname from the DHCP
          # This gets the hostname from the DNS
          #- shell: "hostnamectl set-hostname $(host $(ip a s {{ ansible_default_ipv4.interface }}| awk '/inet /{print $2}'|cut -d '/' -f 1)|awk '{ print $5 }')"

